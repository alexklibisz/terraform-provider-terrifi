# UniFi controller in simulation mode for acceptance testing.
#
# This runs a real UniFi controller with simulated devices, so API validation
# is identical to real hardware. Limitations: no real WAN, WireGuard, or RADIUS.
#
# Used automatically by `task test:acc` (Docker mode). The test harness in
# provider_test.go starts/stops this via testcontainers-go.
services:
  mongo:
    # Note: MongoDB 5.0+ requires AVX CPU instructions. If running in a VM,
    # ensure the hypervisor passes through the host CPU (e.g. cpu type "host"
    # in Proxmox). See https://github.com/docker-library/mongo/issues/619
    image: mongo:8.2
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    configs:
      - source: mongo-init
        target: /docker-entrypoint-initdb.d/init-mongo.sh
        mode: 0755
    restart: unless-stopped

  unifi:
    image: lscr.io/linuxserver/unifi-network-application:version-10.1.85  # pinned; dependabot updates this
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Etc/UTC
      MONGO_HOST: mongo
      MONGO_PORT: 27017
      MONGO_DBNAME: unifi
      MONGO_USER: unifi
      MONGO_PASS: unifi
      MONGO_AUTHSOURCE: admin
      MEM_LIMIT: 1024
      MEM_STARTUP: 1024
    depends_on:
      - mongo
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8443/manage/account/login"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    configs:
      - source: unifi-init
        target: /custom-cont-init.d/demo-mode
        mode: 0755
    ports:
      - 8443:8443
      - 8080:8080
    restart: unless-stopped

configs:
  mongo-init:
    content: |
      #!/bin/bash
      # Init scripts run against the temp mongod (no auth) before it restarts
      # with --auth. Create the unifi user in admin so MONGO_AUTHSOURCE=admin works.
      mongosh admin <<EOJS
      db.createUser({
        user: "unifi",
        pwd: "unifi",
        roles: [
          { db: "unifi", role: "dbOwner" },
          { db: "unifi_stat", role: "dbOwner" },
          { db: "unifi_audit", role: "dbOwner" }
        ]
      })
      EOJS

  unifi-init:
    content: |
      #!/bin/sh

      write_config() {
        echo "$${1}=$${2}" >> /config/data/system.properties
      }

      # Simulation mode creates virtual devices so tests can run without hardware.
      write_config is_simulation true
      write_config demo.num_uap 1
      write_config demo.num_ugw 1
      write_config demo.num_usw 5
