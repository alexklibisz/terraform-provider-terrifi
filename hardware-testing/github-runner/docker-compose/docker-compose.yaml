# GitHub Actions self-hosted runner (Ubuntu-based).
#
# The runner registers itself with GitHub on startup and deregisters cleanly
# on shutdown. Docker socket is mounted so jobs can use Docker (e.g. testcontainers).
#
# Quick start:
#   1. Copy .env.example to .env and fill in the values
#   2. docker compose up -d
#   3. Confirm the runner appears at:
#      https://github.com/<owner>/<repo>/settings/actions/runners

services:
  runner:
    build: .
    image: terrifi-github-runner
    environment:
      REPO_URL: ${REPO_URL}
      ACCESS_TOKEN: ${ACCESS_TOKEN}
      RUNNER_NAME: ${RUNNER_NAME:-terrifi-hardware-runner}
      RUNNER_WORKDIR: /tmp/runner/work
      LABELS: ${LABELS:-self-hosted,terrifi-hardware-test}
      RUNNER_GROUP: ${RUNNER_GROUP:-Default}
      EPHEMERAL: ${EPHEMERAL:-true}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - runner-work:/tmp/runner
    restart: unless-stopped
    # Prevent the runner from being force-killed mid-job
    stop_grace_period: 5m

volumes:
  runner-work:
