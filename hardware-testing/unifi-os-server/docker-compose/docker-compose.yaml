# UniFi controller in host networking mode.
#
# Host networking lets UniFi devices on the local network discover and
# communicate with the controller directly. Use Tailscale on the host
# itself if you also need remote access to the management UI.
#
# Quick start:
#   1. Copy .env.example to .env and set TZ
#   2. docker compose up -d
#   3. Access the UI at https://<host-ip>:8443

services:
  # Stub for the ULP (Unified Logging Platform) API that the UniFi Network
  # Application expects at 127.0.0.1:9080. On real UniFi OS hardware this is
  # provided by UCore; in Docker it's absent, causing noisy log spam.
  ulp-stub:
    image: nginx:alpine
    network_mode: host
    volumes:
      - ./nginx-ulp-stub.conf:/etc/nginx/nginx.conf:ro
    restart: unless-stopped

  mongo:
    image: mongo:8.2
    network_mode: host
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    volumes:
      - mongo-data:/data/db
    configs:
      - source: mongo-init
        target: /docker-entrypoint-initdb.d/init-mongo.sh
        mode: 0755
    restart: unless-stopped

  unifi:
    image: lscr.io/linuxserver/unifi-network-application:version-10.1.85  # pinned; bump as needed
    network_mode: host
    environment:
      PUID: 1000
      PGID: 1000
      TZ: ${TZ:-Etc/UTC}
      MONGO_HOST: localhost
      MONGO_PORT: 27017
      MONGO_DBNAME: unifi
      MONGO_USER: unifi
      MONGO_PASS: unifi
      MONGO_AUTHSOURCE: admin
      MEM_LIMIT: ${MEM_LIMIT:-1024}
      MEM_STARTUP: ${MEM_STARTUP:-1024}
    depends_on:
      - mongo
    volumes:
      - unifi-config:/config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8443/manage/account/login"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

configs:
  mongo-init:
    content: |
      #!/bin/bash
      # Init scripts run against the temp mongod (no auth) before it restarts
      # with --auth. Create the unifi user in admin so MONGO_AUTHSOURCE=admin works.
      mongo admin <<EOJS
      db.createUser({
        user: "unifi",
        pwd: "unifi",
        roles: [
          { db: "unifi", role: "dbOwner" },
          { db: "unifi_stat", role: "dbOwner" },
          { db: "unifi_audit", role: "dbOwner" }
        ]
      })
      EOJS

volumes:
  unifi-config:
  mongo-data:
