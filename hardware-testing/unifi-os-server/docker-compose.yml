# UniFi controller with Tailscale sidecar for tailnet access.
#
# The UniFi container shares the Tailscale container's network namespace, so
# the controller is reachable on your tailnet at:
#   https://<tailscale-ip>:8443   (or https://unifi-controller:8443 via MagicDNS)
#
# Quick start:
#   1. Copy .env.example to .env and fill in TS_AUTHKEY (and TZ)
#   2. docker compose up -d
#   3. Find your Tailscale IP: docker compose exec tailscale tailscale ip -4
#   4. Set SYSTEM_IP= in .env to that IP (required for device adoption), then:
#      docker compose restart unifi

services:
  tailscale:
    image: tailscale/tailscale:stable
    environment:
      TS_AUTHKEY: ${TS_AUTHKEY}
      TS_STATE_DIR: /var/lib/tailscale
      TS_USERSPACE: "false"
      TS_HOSTNAME: ${TS_HOSTNAME:-unifi-controller}
      TS_EXTRA_ARGS: ${TS_EXTRA_ARGS:-}
    volumes:
      - tailscale-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
      - sys_module
    restart: unless-stopped

  unifi:
    image: jacobalberty/unifi:v10.0.162  # pinned; bump as needed
    network_mode: "service:tailscale"
    depends_on:
      - tailscale
    init: true
    environment:
      TZ: ${TZ:-Etc/UTC}
      UNIFI_STDOUT: "true"
      # Set to the Tailscale IP after first startup â€” required for device adoption.
      SYSTEM_IP: ${SYSTEM_IP:-}
      JVM_MAX_HEAP_SIZE: ${JVM_MAX_HEAP_SIZE:-1024M}
    user: unifi
    volumes:
      - unifi-data:/unifi/data
      - unifi-log:/unifi/log
      - unifi-cert:/unifi/cert
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8443/manage/account/login"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

volumes:
  tailscale-state:
  unifi-data:
  unifi-log:
  unifi-cert:
